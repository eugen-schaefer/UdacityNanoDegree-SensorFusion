# Radar

## Overview
Radar is used in vehicles to compensate for the weaknesses of other sensors. The biggest advantage of radar is to measure the radial velocity directly by exploiting the Doppler effect that is helpful for distinguishing between stationary and moving objects. Furthermore, the radar is quite stable against environmental conditions. It performs well day and night, when it rains or snows, also the fog is not a problem. The radar’s capability to determine the targets at short-, mid- and long-range with accurate velocity and spatial information makes it an important sensor for advanced driver assistance systems (ADAS).

Radar works using the transmission and detection of electromagnetic waves as seen in the following image:

<p align="center">
<img src="images/RadarTxRxWaves.png" width="400" />
</p>

The electromagnetic waves are reflected if they meet an obstacle. When these reflected waves are received again at the place of their origin, then that means an obstacle is in the propagation direction.

Automotive radars are small size sensors that can easily fit beneath the front grill or the bumper. As seen in the image below a radar module comprises different parts.

<p align="center">
<img src="images/BoschRadar.png" width="300" />
</p>

* **Radar Dome or Radome**: A radome is a structural, weatherproof enclosure that protects a radar antenna. The radome is constructed of a material that minimally attenuates the electromagnetic signal transmitted or received by the antenna, effectively transparent to radio waves.

* **Radar Printed Circuit Board**: This is analog hardware that includes the radar transceiver and antenna needed for radio wave generation.

* **Printed Circuit Board and Processing**: This includes the Digital Signal Processing (DSP) unit.

There are some comparisons between Radar and Lidar (e.g. [CleanTechnica](https://cleantechnica.com/2016/07/29/tesla-google-disagree-lidar-right/)). 

<p align="center">
<img src="images/Radar_vs_Lidar.png" width="600" />
</p>

LIDAR can generate high resolution imaging based on reflection of the laser light off from the targets. But LIDARs fail in bad weather conditions as the very small wavelength doesn’t allow to work well in fog or rain. Additionally, LIDAR is an expensive sensor with costs varying from $35,000 to $100,000 as of 2019. 

Radar lacks the capability to generate a high resolution image, but it has highly accurate velocity estimation based on the doppler phenomenon. Also, radar wavelength allows it to sense the targets in bad weather conditions as well. Most important is the low manufacturing cost for a Radar. A radar unit can cost as low as a few hundred dollars, allowing a car manufacturer to deploy multiple Radar sensors for 360 degree perception. As of 2021, Tesla relies on Radar as its primary sensor and doesn’t include LIDAR in its sensor fusion system.

## Principle of measurement of FMCW radar

In this course, some basics of an FMCW radar have been enlightened. FMCW radar (Frequency-Modulated Continuous Wave radar) is a special type of radar sensor which radiates continuous transmission power. FMCW radar’s ability to measure very small ranges to the target as well as its ability to measure simultaneously the target range and its relative velocity makes it the first choice type of radar for automotive applications.

In a FMCW radar, both transmitter and receiver operate continuously; the transmitter deploys a sinusoidal carrier with a frequency that increases then decreases periodically over time - a sequence known as a chirp.

The TX signal travels to the target object and is reflected back to the receiver; the difference in frequency between the RX and current TX signal is proportional to travel time, can be used to measure distance, and distinguish between different objects.

### Conceptual block diagram

<p align="center">
<img src="images/RadarHardwareScheme.png" width="700" />
</p>

* **Frequency Synthesizer**: The frequency synthesizer is the component that generates the frequency to bring the chirp frequency all the way to 77GHz in case of automotive radar.

* **Power Amp**: The power amp amplifies the signal such that the signal can reach long distance. Since the signal attenuates as it radiates, it needs higher power (amplitude) to reach targets at greater distances.

* **Antenna**: The antenna converts the electrical energy into electromagnetic waves which radiate through the air, hit the target, and get reflected back toward the radar receiver antenna. The Antenna also increases the strength of the signal by focusing the energy in the desired direction. Additionally, the antenna pattern determines the field of view for the radar.

* **Mixer**: In FMCW radar, the mixer multiplies the return signal with the sweeping signal generated by the frequency synthesizer. The operation works as frequency subtraction to give the frequency delta - also known as frequency shift or Intermediate frequency (IF). IF = Synthesizer Frequency - Return Signal Frequency.

* **Processor**: The processor is the processing unit where all the Digital Signal processing, Detection, Tracking, Clustering, and other algorithms take place. This unit could be a microcontroller or even an FPGA.



### Objects range estimation 

A Frequency Modulated Continous Wave (FMCW) is a signal in which the frequency increases/decreases with time. One possible waveform pattern used for FMCW radars is sawtooth using upramps. Every upramp is also called chirp and defined by its slope which is characterized by the chirp frequency bandwidth B and chirp time T_s.

<p align="center">
<img src="images/BeatFrequency.png" width="600" />
</p>

The top figure shows the TX-signal and the RX-signal that is reflected from an object. The RX-signal is just a delayed version of the TX signal. τ denotes the round-trip time between the radar and the object. 

As previously stated, the mixer multiplies the received signal Rx(t) with the currently transmitted signal Tx(t) resulting in a sinusoid also referred to as the IF signal. The frequency of this sinusoid as the signal at the mixer's output is the difference of the instantaneous frequency of the TX-chirp and RX-chirp and is constant when we disregard the mixed signal at the chirp boundaries. So, a stationary single object in front of the stationary radar produces an IF signal that is a constant frequency tone.

f_b / τ = B / T_s

We know also the round trip time which is the double range between radar and object divided by the waves traveling velocity which is the velocity of light:

τ = 2*R / c

Combining the two mentioned equations we see proportionality between the beat frequency and the range between radar and detected object:

d = (T_s*c) / (2*B) * f_b


In case of a stationary radar and stationary object the sinusoid might have the following form:

Mx(t) = Tx(t) * Rx(t) = A * cos(2 * pi * f_beat * t) where f_beat = (2 * B * R) / (T_s * c)

By looking at the frequency spectrum of the mixed-signal applying Fast Fourier Transform (FFT) we could obtain the beat frequency and hence estimate the range by the given formula above.

<p align="center">
<img src="images/FFT_1D.png" width="400" />
</p>

In the case of multiple objects in front of the radar, the RX antenna would register multiple chirps. A frequency spectrum of the IF signal will reveal multiple tones, the frequency of each being proportional to the range of each object from the radar.

<p align="center">
<img src="images/MultipleChirps.png" width="600" />
</p>

### Objects velocity estimation

As per doppler theory, an approaching target will shift an emitted and reflected frequency higher, whereas a receding target will shift both frequencies to be lower than the transmitted frequency.

<p align="center">
<img src="images/DopplerWaves.png" width="600" />
</p>

The initial phase of the IF-signal at the mixer output is the difference between the initial phases of the two inputs (Tx - Rx). In the case of a stationary object in front of the radar the resulting phase ΔPhi is then zero. When the object and/or radar moves, then both will change: the beat frequency and the phase. The beat frequency will be changed by Δf = (2 * B * ΔR) / (T_s * c). In general, the doppler shift in the beat frequency can be neglected as the following examples illustrate:

Pretend a moving target at the velocity of v_target = 90 km/h = 25 m/s in front of a stationary radar. Assuming a chirp frequency bandwidth B = 2 GHz and chirp time T_s = 40 µs the target would change its position by ΔR = v_target * T_s = 1 mm. The frequency of the IF signal changes then by Δf = (2 * B * ΔR) / (T_s * c) = (2 * 2 * 10⁹ * 10⁻³) / (40 * 10⁻⁶ * 3 * 10⁸) = 333,33 Hz. In the observation window this corresponds to only additional Δf * T_S = 333,33 * 40 * 10⁻⁶ = 0.013 cycles. This change would not be recognizable in the frequency spectrum.

In case of a moving object the sinusoid might get the following form:

Mx(t) = Tx(t) * Rx(t) = A * cos(2 * pi * f_beat * t + ΔPhi) where f_beat = (2 * B * R) / (T_s * c) and ΔPhi = (4 * pi * ΔR) / λ. 

For a 77 GHz radar a position change ΔR of 1 mm means λ/4. So the phase of the IF signal changes by ΔPhi = (4 * pi * ΔR) / λ = pi = 180°. 

As we see the phase of the IF signal is quite sensitive to the Doppler shift and can be the basis for the target's velocity estimation.

So the velocity of an object can be measured by transmitting two chirps separated by T_s. The range-FFTs corresponding to each chirp will have peaks in the same location but with differing phases. The measured phase difference (ΔPhi) corresponds to a motion in the object of v * T_s. The phase difference measured across two consecutive chirps can be used to estimate the velocity of the object:

ΔPhi = (4 * pi * ΔR) / λ = (4 * pi * v * T_s) / λ  --> v = (λ * ΔPhi) / (4 * pi * T_s)


To measure the velocity with multiple objects at the same range, N equi-spaced chirps are transmitted. An FFT on the sequence of phasors corresponding to the range-FFT
peaks resolves the two objects. This is called a doppler-FFT.


<p align="center">
<img src="images/RangeDopplerFFT.png" width="800" />
</p>



## Clutter and approach to cope with it

Radar not only receives the reflected signals from the objects of interest, but also from the environment and unwanted objects. The backscatter from these unwanted sources is called clutter. These unwanted signals are generally produced by the reflections from the ground, sea, buildings, trees, rain, fog, etc.

<p align="center">
<img src="images/Clutter.png" width="800" />
</p>

One technique to remove clutter is to remove the signals having 0 doppler velocity. Since the clutter in the driving scenario is often created by the stationary targets, the 0 doppler filtering can help get to rid of them.

The downside of 0 doppler filtering is that the radar would not be able to detect the stationary targets in its path. This would lead to detection failures.

Another technique is to use fixed clutter thresholding. With fixed thresholding, a signal below the threshold value is rejected. With this method, if the detection threshold is set too high, there will be very few false alarms, but it will also mask the valid targets. If the threshold is set too low, then it would lead to too many false alarms. In other words, the false alarm rate would be too high.

<p align="center">
<img src="images/TargetDetectionsWithFixedThreshold.png" width="500" />
</p>

Yet another approach to clutter thresholding is to use dynamic thresholding. Dynamic thresholding involves varying the threshold level to reduce the false alarm rate.

<p align="center">
<img src="images/TargetDetectionsWithDynamicThreshold.png" width="500" />
</p>


### CA-CFAR

One of the most commonly used techniques for dynamic thresholding is Cell-Averaging Constant False Alarm Rate (CA-CFAR). The CFAR process includes the sliding of a window across the cells in FFT blocks. Each window consists of the following cells.

<p align="center">
<img src="images/CAFAR_Window.png" width="400" />
</p>


* **Cell Under Test (CUT)** : The cell that is tested to detect the presence of the target by comparing the signal level against the noise estimate (threshold).

* **Training Cells** : The level of noise is measured over the Training Cells. The noise is estimated by averaging the noise under the training cells. The number of training cells should be decided based on the environment. If a dense traffic scenario then the fewer training cells should be used, as closely spaced targets can impact the noise estimate.

* **Guard Cells** : The cells just next to CUT are assigned as Guard Cells. The purpose of the Guard Cells is to avoid the target signal from leaking into the training cells that could adversely affect the noise estimate. The number of guard cells should be decided based on the leakage of the target signal out of the cell under test. If target reflections are strong they often get into surrounding bins.

Use an offset value to scale the noise threshold. If the signal strength is defined in logarithmic form then add this offset value to the average noise estimate, else multiply it.

## Final Project

In the final project, a radar target generation and detection have been implemented as follows:

* Configure the FMCW waveform based on the system requirements.
<p align="center">
<img src="images/RadarSystemRequirements.png" width="400" />
</p>

* Define the range and velocity of target and simulate its displacement.
* For the same simulation loop process the transmit and receive signal to determine the beat signal
* Perform Range FFT on the received signal to determine the Range
* Towards the end, perform the CFAR processing on the output of 2nd FFT to display the target.

<p align="center">
<img src="images/ProjectLayout.png" width="700" />
</p>

While simulating the FMCW for the transmitted and received signal, two options have been implemented (You can choose between these options by adapting the boolean flag 'reset_chirp' in the Matlab code accordingly): 

* Chirp frequency is resetted after every chirp time resulting in a sawtooth form (Practical case)
<p align="center">
<img src="images/RangeFFT_ResettedChirp.png" width="700" />
</p>

<p align="center">
<img src="images/DopplerFFT_ResettedChirp.png" width="700" />
</p>

* Chirp frequency is never resetted (Theoretical case)
<p align="center">
<img src="images/RangeFFT_ContinuousChirp.png" width="700" />
</p>

<p align="center">
<img src="images/RangeDopplerFFT_ContinuousChirp.png" width="700" />
</p>

Target's initial position and velocity have been defined as following:
* R = 110 m
* v = -20 m/s (const.)

The observation is that while the 1D-Range-FFT shows reliable estimation for the range in both options, the estimations in 2D-Range-Doppler-FFT deviate from ground truth in the case reset frequency chirp although the parts of the mixed-signal at chirp boundaries have been disregarded.